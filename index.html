<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì›¹ í¬íŠ¸í´ë¦¬ì˜¤ ì°¨íŠ¸</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@400;600&display=swap');

    :root {
      --bg-primary: #f0f2f5;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f8f9fa;
      --text-primary: #1a1a2e;
      --text-secondary: #555770;
      --text-muted: #8b8fa3;
      --border-color: #e0e3eb;
      --border-hover: #c0c4d0;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.06);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
      --brand-primary: #4f6ef7;
      --brand-primary-hover: #3b5de7;
      --brand-success: #22c55e;
      --brand-success-hover: #16a34a;
      --brand-warning: #f59e0b;
      --brand-warning-hover: #d97706;
      --brand-danger: #ef4444;
      --brand-danger-hover: #dc2626;
      --brand-dividend: #8b5cf6;
      --brand-dividend-hover: #7c3aed;
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 20px;
      --transition: 0.2s ease;
      --focus-ring: 0 0 0 3px rgba(79,110,247,0.25);
    }

    [data-theme="dark"] {
      --bg-primary: #0f1117;
      --bg-secondary: #1a1b26;
      --bg-tertiary: #21222e;
      --text-primary: #e4e5f1;
      --text-secondary: #a9adc1;
      --text-muted: #6b7194;
      --border-color: #2e3044;
      --border-hover: #3d4060;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.5);
      --brand-primary: #6c8cff;
      --brand-primary-hover: #5a7af0;
      --focus-ring: 0 0 0 3px rgba(108,140,255,0.3);
    }

    @media (prefers-color-scheme: dark) {
      html:not([data-theme="light"]) {
        --bg-primary: #0f1117;
        --bg-secondary: #1a1b26;
        --bg-tertiary: #21222e;
        --text-primary: #e4e5f1;
        --text-secondary: #a9adc1;
        --text-muted: #6b7194;
        --border-color: #2e3044;
        --border-hover: #3d4060;
        --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
        --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
        --shadow-lg: 0 8px 24px rgba(0,0,0,0.5);
        --brand-primary: #6c8cff;
        --brand-primary-hover: #5a7af0;
        --focus-ring: 0 0 0 3px rgba(108,140,255,0.3);
      }
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'IBM Plex Sans KR', sans-serif;
      padding: 20px;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      max-width: 720px;
      margin: 0 auto;
      transition: background-color var(--transition), color var(--transition);
    }

    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .header h2 {
      color: var(--text-primary);
      font-weight: 600;
      font-size: 22px;
    }

    .theme-toggle {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition);
      color: var(--text-primary);
    }

    .theme-toggle:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
      border-color: var(--border-hover);
    }

    h3 {
      color: var(--text-primary);
      font-weight: 600;
      margin-top: 24px;
      margin-bottom: 12px;
    }

    input, select {
      margin: 5px;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-color);
      font-size: 14px;
      font-family: 'IBM Plex Sans KR', sans-serif;
      background: var(--bg-secondary);
      color: var(--text-primary);
      transition: all var(--transition);
    }

    input:focus, select:focus {
      outline: none;
      border-color: var(--brand-primary);
      box-shadow: var(--focus-ring);
    }

    button {
      margin: 5px;
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      border: none;
      font-size: 14px;
      font-family: 'IBM Plex Sans KR', sans-serif;
      background-color: var(--brand-primary);
      color: white;
      cursor: pointer;
      font-weight: 600;
      transition: all var(--transition);
    }

    button:hover {
      background-color: var(--brand-primary-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    button:active {
      transform: translateY(0);
    }

    .btn-warning {
      background-color: var(--brand-warning);
    }
    .btn-warning:hover {
      background-color: var(--brand-warning-hover);
    }

    .btn-danger {
      background-color: var(--brand-danger);
    }
    .btn-danger:hover {
      background-color: var(--brand-danger-hover);
    }

    .btn-success {
      background-color: var(--brand-success);
    }
    .btn-success:hover {
      background-color: var(--brand-success-hover);
    }

    .btn-dividend {
      background-color: var(--brand-dividend);
    }
    .btn-dividend:hover {
      background-color: var(--brand-dividend-hover);
    }

    .btn-sm {
      padding: 6px 10px;
      font-size: 13px;
      margin: 2px;
    }

    .item-list { margin-top: 15px; font-size: 14px; }

    .portfolio-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      background: var(--bg-secondary);
      padding: 14px 16px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
      transition: all var(--transition);
    }

    .portfolio-item:hover {
      box-shadow: var(--shadow-md);
      border-color: var(--border-hover);
      transform: translateY(-1px);
    }

    .portfolio-item-content {
      text-align: left;
      flex: 1;
    }

    .portfolio-item-content .item-name {
      font-weight: 600;
      color: var(--text-primary);
    }

    .portfolio-item-content .item-meta {
      margin-top: 4px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .portfolio-item-actions {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }

    #portfolioChartContainer {
      position: relative;
      width: 100%;
      max-width: 500px;
      margin: 24px auto;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 20px;
      box-shadow: var(--shadow-sm);
    }

    #portfolioChart {
      width: 100% !important;
      height: auto !important;
    }

    .category-buttons {
      margin: 10px auto 15px auto;
      text-align: center;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
    }

    .category-buttons button {
      min-height: 35px;
      min-width: 60px;
      padding: 8px 16px;
      font-weight: 600;
      border: 2px solid var(--brand-success);
      background-color: var(--bg-secondary);
      color: var(--brand-success);
      border-radius: var(--radius-lg);
      transition: all var(--transition);
    }

    .category-buttons button:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-sm);
    }

    .category-buttons button.active {
      background-color: var(--brand-success);
      color: white;
    }

    .total {
      margin-top: 16px;
      font-weight: 700;
      text-align: center;
      font-size: 18px;
      padding: 16px 20px;
      border-radius: var(--radius-md);
      background: linear-gradient(135deg, var(--brand-primary), var(--brand-success));
      color: white;
      box-shadow: var(--shadow-md);
    }

    .totals-breakdown {
      text-align: center;
      font-size: 14px;
      margin-top: 8px;
      color: var(--text-secondary);
    }

    input[type="file"] {
      display: none;
    }

    .file-label {
      display: inline-block;
      background-color: var(--brand-primary);
      color: white;
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 600;
      margin: 5px;
      font-size: 14px;
      transition: all var(--transition);
    }

    .file-label:hover {
      background-color: var(--brand-primary-hover);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .form-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-top: 12px;
      box-shadow: var(--shadow-sm);
    }

    .exchange-rate-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 12px 16px;
      margin-top: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .exchange-rate-section label {
      color: var(--text-secondary);
      font-size: 14px;
      white-space: nowrap;
    }

    .exchange-rate-section input {
      width: 120px;
    }

    .data-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-top: 12px;
      box-shadow: var(--shadow-sm);
    }

    .data-section h3 {
      margin-top: 0;
    }

    .firebase-section {
      margin-top: 8px;
    }

    .chart-list-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .chart-list-item span {
      flex: 1;
      color: var(--text-primary);
    }

    /* Dividend Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.2s ease;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 24px;
      width: 90%;
      max-width: 520px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      animation: slideUp 0.3s ease;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 18px;
    }

    .modal-close {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      padding: 0;
      margin: 0;
    }

    .modal-close:hover {
      background: var(--brand-danger);
      color: white;
      transform: none;
    }

    .dividend-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 16px;
    }

    .dividend-form input,
    .dividend-form select {
      margin: 0;
      width: 100%;
    }

    .dividend-form .full-width {
      grid-column: 1 / -1;
    }

    .dividend-history {
      border-top: 1px solid var(--border-color);
      padding-top: 12px;
    }

    .dividend-history h4 {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .dividend-record {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      margin-bottom: 6px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-color);
      font-size: 13px;
    }

    .dividend-record-info {
      flex: 1;
    }

    .dividend-record-amount {
      font-weight: 600;
      color: var(--brand-dividend);
    }

    .dividend-record-meta {
      color: var(--text-muted);
      font-size: 12px;
      margin-top: 2px;
    }

    /* Dividend List */
    .dividend-list-section {
      margin-top: 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 20px;
      box-shadow: var(--shadow-sm);
    }

    .dividend-list-section h3 {
      margin: 0 0 12px 0;
      font-size: 16px;
    }

    /* Dividend Summary */
    .dividend-summary {
      margin-top: 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      padding: 20px;
      box-shadow: var(--shadow-sm);
    }

    .dividend-summary h3 {
      margin: 0 0 16px 0;
      font-size: 16px;
    }

    .dividend-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }

    .dividend-stat-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-sm);
      padding: 12px;
      text-align: center;
    }

    .dividend-stat-card .stat-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--brand-dividend);
    }

    .dividend-stat-card .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }


    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 640px) {
      body { padding: 12px; }

      .portfolio-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .portfolio-item-actions {
        align-self: flex-end;
      }

      .dividend-stats {
        grid-template-columns: 1fr;
      }

      .dividend-form {
        grid-template-columns: 1fr;
      }

      .exchange-rate-section {
        flex-direction: column;
        align-items: flex-start;
      }

      .exchange-rate-section input {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <h2>ğŸ“Š ì›¹ í¬íŠ¸í´ë¦¬ì˜¤ ì°¨íŠ¸</h2>
    <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()">ğŸŒ™</button>
  </div>

  <button id="loginBtn" hidden>Google ë¡œê·¸ì¸</button>
  <button id="logoutBtn" hidden>ë¡œê·¸ì•„ì›ƒ</button>
  <input hidden id="chartTitle" value="ë‚˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤" onchange="updateChart()" />
  <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
    <input
      id="chartNameInput"
      hidden
      type="text"
      placeholder="ì°¨íŠ¸ ì´ë¦„ ì…ë ¥"
      onchange="updateChart()"
    />
    <button
      id="firebaseSaveBtn"
      hidden
      class="btn-success"
    >
      ì°¨íŠ¸ ì €ì¥
    </button>
  </div>

  <div style="margin-top:12px; display:flex; gap:6px; flex-wrap:wrap;">
    <button onclick="toggleForm()">+ ì¢…ëª© ì¶”ê°€</button>
    <button class="btn-dividend" onclick="openDividendModal()">+ ë°°ë‹¹ê¸ˆ ì¶”ê°€</button>
  </div>

  <div id="form" class="form-section" style="display:none;">
    <input id="name" placeholder="ì¢…ëª© ì´ë¦„" />
    <input id="amount" type="number" placeholder="ê°œìˆ˜" />
    <input id="price" type="number" placeholder="ê°€ê²©" />
    <select id="currency">
      <option value="KRW">ì›</option>
      <option value="USD">ë‹¬ëŸ¬</option>
    </select>
    <input id="category" placeholder="ì¹´í…Œê³ ë¦¬ (ì‰¼í‘œë¡œ êµ¬ë¶„)" />
    <button onclick="submitItem()">í™•ì¸</button>
  </div>

  <div class="exchange-rate-section">
    <label>ğŸ’± í™˜ìœ¨ (1 USD = ì›í™”):</label>
    <input id="exchangeRate" type="number" value="1300" onchange="updateAll()" />
  </div>

  <div class="item-list" id="itemList"></div>

  <div id="portfolioChartContainer">
    <canvas id="portfolioChart"></canvas>
  </div>

  <div class="category-buttons" id="categoryButtons"></div>

  <div class="total" id="totalAmount"></div>
  <div class="totals-breakdown" id="categoryTotals"></div>

  <div id="dividendListContainer"></div>
  <div id="dividendSummaryContainer"></div>

  <div class="data-section">
    <h3>ğŸ“‚ ë°ì´í„° ì €ì¥ ë° ë¶ˆëŸ¬ì˜¤ê¸°</h3>
    <button onclick="saveData()">ğŸ’¾ ì €ì¥ (ë¡œì»¬)</button>
    <button onclick="loadData()">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸° (ë¡œì»¬)</button>
    <button onclick="downloadCSV()">â¬‡ï¸ CSV ë‹¤ìš´ë¡œë“œ</button>
    <button onclick="downloadJSON()">â¬‡ï¸ JSON ë‹¤ìš´ë¡œë“œ</button>
    <label for="fileUpload" class="file-label">ğŸ“ JSON ì—…ë¡œë“œ</label>
    <input type="file" id="fileUpload" accept=".json" onchange="uploadFile(event)" />
    <label for="csvUpload" class="file-label">ğŸ“ CSV ì—…ë¡œë“œ</label>
    <input type="file" id="csvUpload" accept=".csv" onchange="uploadCSVFile(event)" />
  </div>

  <div class="firebase-section">
    <h3>ğŸ“Š Google ê³„ì •ì— ì €ì¥ëœ ì°¨íŠ¸ ëª©ë¡</h3>
    <div id="chartList"></div>
  </div>

  <!-- Dividend Modal -->
  <div class="modal-overlay" id="dividendModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="dividendModalTitle">ğŸ’° ë°°ë‹¹ê¸ˆ ê¸°ë¡</h3>
        <button class="modal-close" onclick="closeDividendModal()">âœ•</button>
      </div>
      <div class="dividend-form">
        <input id="divStockName" class="full-width" list="divStockList" placeholder="ì¢…ëª© ì´ë¦„ (ì§ì ‘ ì…ë ¥ ë˜ëŠ” ì„ íƒ)" />
        <datalist id="divStockList"></datalist>
        <input id="divShares" type="number" placeholder="ì£¼ì‹ ìˆ˜" />
        <input id="divAmount" type="number" step="0.01" placeholder="ì£¼ë‹¹ ë°°ë‹¹ê¸ˆ" />
        <select id="divCurrency">
          <option value="KRW">KRW (ì›)</option>
          <option value="USD">USD (ë‹¬ëŸ¬)</option>
        </select>
        <input id="divDate" type="date" />
        <select id="divFrequency">
          <option value="one-time">ì¼íšŒì„±</option>
          <option value="monthly">ì›”ë°°ë‹¹</option>
          <option value="quarterly">ë¶„ê¸°ë°°ë‹¹</option>
          <option value="annually">ì—°ë°°ë‹¹</option>
        </select>
        <input id="divNote" class="full-width" placeholder="ë©”ëª¨ (ì„ íƒ)" />
        <div class="full-width">
          <button class="btn-dividend" onclick="addDividendRecord()">ë°°ë‹¹ê¸ˆ ì¶”ê°€</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc } from 'https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js';
    import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC1-dNvQQbb4B5j6N5hZCI4dT8yTVu8y8o",
      authDomain: "my-portfolio-app-ae0e6.firebaseapp.com",
      databaseURL: "https://my-portfolio-app-ae0e6-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "my-portfolio-app-ae0e6",
      storageBucket: "my-portfolio-app-ae0e6.firebasestorage.app",
      messagingSenderId: "297732155840",
      appId: "1:297732155840:web:e7b288878e27f69fcc0025",
      measurementId: "G-HXMCWTC9PS"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    let currentUser = null;

    loginBtn.addEventListener('click', async () => {
      const provider = new GoogleAuthProvider();
      try {
        const result = await signInWithPopup(auth, provider);
        currentUser = result.user;
        console.log('ë¡œê·¸ì¸:', currentUser.email);
      } catch (err) {
        console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', err.message);
      }
    });

    logoutBtn.addEventListener('click', () => {
      signOut(auth);
    });

    onAuthStateChanged(auth, user => {
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const firebaseSaveBtn = document.getElementById("firebaseSaveBtn");
      const chartNameInput = document.getElementById("chartNameInput");
      if (user) {
        currentUser = user;
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        firebaseSaveBtn.style.display = 'inline-block';
        chartNameInput.style.display = 'inline-block';
        loadChartList();
      } else {
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        firebaseSaveBtn.style.display = 'none';
        chartNameInput.style.display = 'none';
        const chartListDiv = document.getElementById('chartList');
        chartListDiv.innerHTML = '';
      }
    });

    const firebaseSaveBtn = document.getElementById('firebaseSaveBtn');
    const chartNameInput = document.getElementById('chartNameInput');

    firebaseSaveBtn.addEventListener('click', async () => {
      const chartName = chartNameInput.value.trim();
      if (!chartName) {
        alert('ì°¨íŠ¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!');
        return;
      }
      await saveToFirebase(chartName);
      chartNameInput.value = '';
    });

    async function saveToFirebase(chartName) {
      const data = {
        items,
        dividendRecords,
        exchangeRate: getExchangeRate()
      };
      await setDoc(doc(db, 'dev_users', currentUser.uid, 'charts', chartName), {
        jsonData: JSON.stringify(data)
      });
      alert(`'${chartName}' ì´ë¦„ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      loadChartList();
    }

    async function loadChartList() {
      const chartListDiv = document.getElementById('chartList');
      chartListDiv.innerHTML = '';

      const chartsRef = collection(db, 'dev_users', currentUser.uid, 'charts');
      const snapshot = await getDocs(chartsRef);

      snapshot.forEach(docSnap => {
        const chartName = docSnap.id;

        const div = document.createElement('div');
        div.className = "chart-list-item";

        const nameSpan = document.createElement('span');
        nameSpan.textContent = chartName;

        const loadButton = document.createElement('button');
        loadButton.textContent = 'ë¶ˆëŸ¬ì˜¤ê¸°';
        loadButton.className = "btn-success btn-sm";
        loadButton.addEventListener('click', () => loadChart(chartName));

        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'ì‚­ì œí•˜ê¸°';
        deleteButton.className = "btn-danger btn-sm";
        deleteButton.addEventListener('click', (event) => {
          const chartDiv = event.target.closest('.chart-list-item');
          deleteChart(chartDiv, chartName);
        });

        div.appendChild(nameSpan);
        div.appendChild(loadButton);
        div.appendChild(deleteButton);
        chartListDiv.appendChild(div);
      });

      if (snapshot.empty) {
        chartListDiv.innerHTML = '<p style="color:var(--text-muted);font-size:14px;">ì €ì¥ëœ ì°¨íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      }
    }

    async function loadChart(chartName) {
      const chartDocRef = doc(db, 'dev_users', currentUser.uid, 'charts', chartName);
      const chartDoc = await getDoc(chartDocRef);

      if (chartDoc.exists()) {
        const data = JSON.parse(chartDoc.data().jsonData);
        items = data.items || [];
        dividendRecords = data.dividendRecords || [];
        document.getElementById('exchangeRate').value = data.exchangeRate || 1300;
        updateAll();
      } else {
        alert('ì°¨íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
    }

    async function deleteChart(selfElement, chartName) {
      const chartDocRef = doc(db, 'dev_users', currentUser.uid, 'charts', chartName);
      const chartDoc = await getDoc(chartDocRef);

      if (chartDoc.exists()) {
        try {
          await deleteDoc(chartDocRef);
          alert("ì‚­ì œ ì™„ë£Œ!");
          selfElement.remove();
        } catch (error) {
          console.error("ì°¨íŠ¸ ì‚­ì œ ì˜¤ë¥˜:", error);
        }
        updateAll();
      } else {
        alert('ì°¨íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
    }
  </script>

  <script>
    let items = [];
    let dividendRecords = [];
    let portfolioChart = null;
    let selectedCategories = new Set();
    let editingIndex = null;

    // Theme
    function getPreferredTheme() {
      const saved = localStorage.getItem('theme');
      if (saved) return saved;
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    function applyTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      document.getElementById('themeToggle').textContent = theme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
      if (portfolioChart) updateChart();
    }

    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme') || getPreferredTheme();
      const next = current === 'dark' ? 'light' : 'dark';
      localStorage.setItem('theme', next);
      applyTheme(next);
    }

    applyTheme(getPreferredTheme());

    function toggleForm() {
      const form = document.getElementById('form');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
      if (form.style.display === 'none') clearForm();
    }

    function submitItem() {
      const name = document.getElementById('name').value;
      const amount = parseFloat(document.getElementById('amount').value);
      const price = parseFloat(document.getElementById('price').value);
      const currency = document.getElementById('currency').value;
      const categories = document.getElementById('category').value.split(',').map(c => c.trim()).filter(c => c);
      const date = new Date().toISOString().split('T')[0];

      if (!name || isNaN(amount) || isNaN(price)) {
        alert('ì´ë¦„, ê°œìˆ˜, ê°€ê²©ì„ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      if (editingIndex !== null) {
        items[editingIndex] = { name, amount, price, currency, categories, date };
        editingIndex = null;
      } else {
        items.push({ name, amount, price, currency, categories, date });
      }

      clearForm();
      updateAll();
    }

    function editItem(index) {
      const item = items[index];
      document.getElementById('name').value = item.name;
      document.getElementById('amount').value = item.amount;
      document.getElementById('price').value = item.price;
      document.getElementById('currency').value = item.currency;
      document.getElementById('category').value = item.categories.join(', ');
      editingIndex = index;
      document.getElementById('form').style.display = 'block';
    }

    function deleteItem(index) {
      if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        items.splice(index, 1);
        updateAll();
      }
    }

    function clearForm() {
      document.getElementById('name').value = '';
      document.getElementById('amount').value = '';
      document.getElementById('price').value = '';
      document.getElementById('currency').value = 'KRW';
      document.getElementById('category').value = '';
      editingIndex = null;
    }

    function getExchangeRate() {
      return parseFloat(document.getElementById('exchangeRate').value);
    }

    function getTotalValue(item) {
      const rate = getExchangeRate();
      return item.currency === 'USD' ? item.amount * item.price * rate : item.amount * item.price;
    }

    function updateAll() {
      updateList();
      updateCategoryButtons();
      updateChart();
      updateTotal();
      updateDividendList();
      updateDividendSummary();
    }

    function updateList() {
      const list = document.getElementById('itemList');
      list.innerHTML = items.map((i, idx) => `
        <div class="portfolio-item">
          <div class="portfolio-item-content">
            <div class="item-name">ğŸ“Œ ${i.name} - ${i.amount}ê°œ x ${i.price.toLocaleString()}${i.currency === 'USD' ? '$' : 'ì›'} = ${getTotalValue(i).toLocaleString()}ì›</div>
            <div class="item-meta">
              [${i.categories.join(', ')} | ${i.date}]
            </div>
          </div>
          <div class="portfolio-item-actions">
            <button class="btn-warning btn-sm" onclick="editItem(${idx})">âœï¸</button>
            <button class="btn-danger btn-sm" onclick="deleteItem(${idx})">ğŸ—‘ï¸</button>
          </div>
        </div>`).join('');
    }

    function updateCategoryButtons() {
      const container = document.getElementById('categoryButtons');
      const allCategories = [...new Set(items.flatMap(i => i.categories))];

      if (allCategories.length === 0) {
        container.innerHTML = '';
        return;
      }

      const isAllSelected = selectedCategories.size === allCategories.length;
      const allButtonText = isAllSelected ? 'ì „ì²´ í•´ì œ' : 'ì „ì²´ ì„ íƒ';

      let html = `
        <button onclick="toggleAllCategories()"
          class="${isAllSelected || selectedCategories.size === 0 ? 'active' : ''}">
          ${allButtonText}
        </button>
      `;

      html += allCategories.map(cat => `
        <button onclick="toggleCategory('${cat}')" class="${selectedCategories.has(cat) ? 'active' : ''}">
          ${cat}
        </button>
      `).join('');

      container.innerHTML = html;
    }

    function toggleAllCategories() {
      const allCategories = [...new Set(items.flatMap(i => i.categories))];

      if (selectedCategories.size === allCategories.length) {
        selectedCategories.clear();
      } else {
        selectedCategories = new Set(allCategories);
      }

      updateCategoryButtons();
      updateChart();
      updateTotal();
    }

    function toggleCategory(cat) {
      if (selectedCategories.has(cat)) {
        selectedCategories.delete(cat);
      } else {
        selectedCategories.add(cat);
      }
      updateCategoryButtons();
      updateChart();
      updateTotal();
    }

    const CHART_COLORS = ['#6366f1', '#22c55e', '#f59e0b', '#ef4444', '#06b6d4', '#ec4899'];

    function updateChart() {
      const ctx = document.getElementById('portfolioChart').getContext('2d');
      const categorySums = {};
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark' ||
        (!document.documentElement.getAttribute('data-theme') && window.matchMedia('(prefers-color-scheme: dark)').matches);

      items.forEach(item => {
        const value = getTotalValue(item);
        item.categories.forEach(cat => {
          if (selectedCategories.size === 0 || selectedCategories.has(cat)) {
            categorySums[cat] = (categorySums[cat] || 0) + value;
          }
        });
      });

      const labels = Object.keys(categorySums);
      const values = Object.values(categorySums);

      if (portfolioChart) portfolioChart.destroy();

      const textColor = isDark ? '#e4e5f1' : '#1a1a2e';
      const borderColor = isDark ? '#1a1b26' : '#ffffff';

      portfolioChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: CHART_COLORS,
            borderColor: borderColor,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            datalabels: {
              formatter: (value, context) => {
                const sum = context.chart._metasets[0].total;
                const percentage = ((value / sum) * 100).toFixed(1) + '%';
                return percentage;
              },
              color: '#fff',
              font: { weight: 'bold', size: 13 }
            },
            legend: {
              position: 'bottom',
              labels: {
                color: textColor,
                usePointStyle: true,
                padding: 16,
                font: { size: 13 }
              }
            },
            title: {
              display: true,
              text: document.getElementById('chartTitle').value,
              color: textColor,
              font: { size: 16, weight: '600' }
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    function updateTotal() {
      const totalDiv = document.getElementById('totalAmount');
      let sum = 0;
      items.forEach(item => {
        const value = getTotalValue(item);
        const matched = item.categories.some(cat => selectedCategories.size === 0 || selectedCategories.has(cat));
        if (matched) sum += value;
      });
      totalDiv.textContent = `ì´í•©: ${sum.toLocaleString()} ì›`;
    }

    // Dividend functions
    function openDividendModal() {
      const datalist = document.getElementById('divStockList');
      datalist.innerHTML = items.map(item => `<option value="${item.name}">`).join('');

      document.getElementById('dividendModalTitle').textContent = 'ğŸ’° ë°°ë‹¹ê¸ˆ ì¶”ê°€';
      document.getElementById('divStockName').value = '';
      document.getElementById('divShares').value = '';
      document.getElementById('divDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('divAmount').value = '';
      document.getElementById('divNote').value = '';
      document.getElementById('divFrequency').value = 'one-time';
      document.getElementById('divCurrency').value = 'KRW';

      document.getElementById('dividendModal').classList.add('active');
    }

    function closeDividendModal() {
      document.getElementById('dividendModal').classList.remove('active');
    }

    function addDividendRecord() {
      const stockName = document.getElementById('divStockName').value.trim();
      const shares = parseFloat(document.getElementById('divShares').value);
      const amount = parseFloat(document.getElementById('divAmount').value);
      const currency = document.getElementById('divCurrency').value;
      const paymentDate = document.getElementById('divDate').value;
      const frequency = document.getElementById('divFrequency').value;
      const note = document.getElementById('divNote').value.trim();

      if (!stockName) {
        alert('ì¢…ëª© ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      if (isNaN(shares) || shares <= 0) {
        alert('ì£¼ì‹ ìˆ˜ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      if (isNaN(amount) || amount <= 0) {
        alert('ë°°ë‹¹ê¸ˆ ê¸ˆì•¡ì„ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      if (!paymentDate) {
        alert('ì§€ê¸‰ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      dividendRecords.push({
        id: Date.now().toString(36) + Math.random().toString(36).slice(2, 7),
        stockName,
        shares,
        amount,
        currency,
        paymentDate,
        frequency,
        note
      });

      document.getElementById('divStockName').value = '';
      document.getElementById('divShares').value = '';
      document.getElementById('divAmount').value = '';
      document.getElementById('divNote').value = '';
      updateDividendList();
      updateDividendSummary();
    }

    function updateDividendList() {
      const container = document.getElementById('dividendListContainer');
      const rate = getExchangeRate();
      const freqLabels = { 'one-time': 'ì¼íšŒì„±', 'monthly': 'ì›”ë°°ë‹¹', 'quarterly': 'ë¶„ê¸°ë°°ë‹¹', 'annually': 'ì—°ë°°ë‹¹' };

      if (dividendRecords.length === 0) {
        container.innerHTML = '';
        return;
      }

      const sorted = dividendRecords.slice().sort((a, b) => b.paymentDate.localeCompare(a.paymentDate));

      container.innerHTML = `
        <div class="dividend-list-section">
          <h3>ğŸ’° ë°°ë‹¹ê¸ˆ ë‚´ì—­ (${sorted.length}ê±´)</h3>
          ${sorted.map(r => {
            const total = r.amount * r.shares;
            const krw = r.currency === 'USD' ? total * rate : total;
            return `
            <div class="dividend-record">
              <div class="dividend-record-info">
                <div class="dividend-record-amount">
                  ${r.stockName} â€” ${r.currency === 'USD' ? '$' : ''}${r.amount.toLocaleString()}${r.currency === 'KRW' ? 'ì›' : ''}/ì£¼ x ${r.shares}ì£¼ = ${krw.toLocaleString()}ì›
                </div>
                <div class="dividend-record-meta">
                  ${r.paymentDate} Â· ${freqLabels[r.frequency] || r.frequency}${r.note ? ' Â· ' + r.note : ''}
                </div>
              </div>
              <button class="btn-danger btn-sm" onclick="deleteDividendById('${r.id}')">ğŸ—‘ï¸</button>
            </div>`;
          }).join('')}
        </div>
      `;
    }

    function deleteDividendById(id) {
      if (confirm('ì´ ë°°ë‹¹ê¸ˆ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        dividendRecords = dividendRecords.filter(d => d.id !== id);
        updateDividendList();
        updateDividendSummary();
      }
    }

    function updateDividendSummary() {
      const container = document.getElementById('dividendSummaryContainer');
      const rate = getExchangeRate();

      if (dividendRecords.length === 0) {
        container.innerHTML = '';
        return;
      }

      const totalKRW = dividendRecords.reduce((s, d) => {
        const total = d.amount * d.shares;
        return s + (d.currency === 'USD' ? total * rate : total);
      }, 0);

      container.innerHTML = `
        <div class="dividend-summary">
          <h3>ğŸ’° ë°°ë‹¹ê¸ˆ ìš”ì•½</h3>
          <div class="dividend-stats">
            <div class="dividend-stat-card">
              <div class="stat-value">${totalKRW.toLocaleString()}</div>
              <div class="stat-label">ì´ ë°°ë‹¹ê¸ˆ (ì›)</div>
            </div>
            <div class="dividend-stat-card">
              <div class="stat-value">${dividendRecords.length}ê±´</div>
              <div class="stat-label">ê¸°ë¡ ê±´ìˆ˜</div>
            </div>
          </div>
        </div>
      `;
    }

    // Data persistence
    function saveData() {
      const data = {
        items,
        dividendRecords,
        exchangeRate: getExchangeRate()
      };
      localStorage.setItem('portfolioData', JSON.stringify(data));
      alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function loadData() {
      const data = localStorage.getItem('portfolioData');
      if (data) {
        const parsed = JSON.parse(data);
        items = parsed.items || [];
        dividendRecords = parsed.dividendRecords || [];
        document.getElementById('exchangeRate').value = parsed.exchangeRate || 1300;
        updateAll();
        alert('ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');
      } else {
        alert('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
      }
    }

    function downloadJSON() {
      const blob = new Blob([JSON.stringify({ items, dividendRecords, exchangeRate: getExchangeRate() }, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'portfolio.json';
      a.click();
    }

    function downloadCSV() {
      const header = 'ì´ë¦„,ê°œìˆ˜,ê°€ê²©,í†µí™”,ì¹´í…Œê³ ë¦¬,ë‚ ì§œ\n';
      const rows = items.map(i => `${i.name},${i.amount},${i.price},${i.currency},"${i.categories.join('|')}",${i.date}`).join('\n');
      const blob = new Blob([header + rows], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'portfolio.csv';
      a.click();
    }

    function uploadFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          items = data.items || [];
          dividendRecords = data.dividendRecords || [];
          document.getElementById('exchangeRate').value = data.exchangeRate || 1300;
          updateAll();
          alert('íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');
        } catch (e) {
          alert('JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function uploadCSVFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const lines = text.trim().split('\n');
          const dataLines = lines.slice(1);

          const parsedItems = dataLines.filter(line => line.trim()).map(line => {
            const match = line.match(/^(.*?),([\d.]+),([\d.]+),(KRW|USD),"([^"]*)",(\d{4}-\d{2}-\d{2})$/);
            if (!match) throw new Error('CSV í˜•ì‹ ì˜¤ë¥˜: ' + line);

            const [, name, amount, price, currency, categories, date] = match;
            return {
              name: name.trim(),
              amount: parseFloat(amount),
              price: parseFloat(price),
              currency: currency.trim(),
              categories: categories.split('|').map(c => c.trim()),
              date: date.trim()
            };
          });

          items = parsedItems;
          updateAll();
          alert('CSV íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!');
        } catch (err) {
          alert('CSV í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
          console.error(err);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // Close modal on overlay click
    document.getElementById('dividendModal').addEventListener('click', function(e) {
      if (e.target === this) closeDividendModal();
    });

    updateAll();
  </script>
</body>
</html>
