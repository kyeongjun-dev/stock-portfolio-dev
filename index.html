<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì›¹ í¬íŠ¸í´ë¦¬ì˜¤ ì°¨íŠ¸</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+KR:wght@400;600&display=swap');

    :root {
      --bg-primary: #f8f9fa;
      --bg-secondary: #fff;
      --bg-form: #fff;
      --text-primary: #333;
      --text-secondary: #555;
      --text-heading: #2c3e50;
      --border-color: #ccc;
      --shadow: rgba(0,0,0,0.1);
      --dividend-record-bg: #f1f3f5;
      --modal-bg: white;
      --overlay-bg: rgba(0,0,0,0.5);
      --cat-btn-bg: white;
      --btn-primary: #3498db;
      --btn-primary-hover: #2980b9;
      --btn-danger: #e74c3c;
      --btn-edit: #f39c12;
      --btn-dividend: #8e44ad;
      --btn-dividend-hover: #9b59b6;
      --btn-save: #27ae60;
      --file-label-bg: #3498db;
      --chart-legend-color: #666;
      --chart-title-color: #333;
    }

    [data-theme="dark"] {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-form: #0f3460;
      --text-primary: #e0e0e0;
      --text-secondary: #b0b0b0;
      --text-heading: #e0e0e0;
      --border-color: #444;
      --shadow: rgba(0,0,0,0.4);
      --dividend-record-bg: #16213e;
      --modal-bg: #1a1a2e;
      --overlay-bg: rgba(0,0,0,0.7);
      --cat-btn-bg: #16213e;
      --btn-primary: #1a6fb5;
      --btn-primary-hover: #155a94;
      --btn-danger: #a93226;
      --btn-edit: #b87a0a;
      --btn-dividend: #6c3483;
      --btn-dividend-hover: #7d3c98;
      --btn-save: #1e8449;
      --file-label-bg: #1a6fb5;
      --chart-legend-color: #ccc;
      --chart-title-color: #e0e0e0;
    }

    body {
      font-family: 'IBM Plex Sans KR', sans-serif;
      padding: 20px;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      max-width: 700px;
      margin: 0 auto;
      transition: background-color 0.3s, color 0.3s;
    }
    h2, h3 { color: var(--text-heading); font-weight: 600; }
    input, select, button {
      margin: 5px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      font-size: 14px;
      font-family: 'IBM Plex Sans KR', sans-serif;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
    }
    button {
      background-color: var(--btn-primary);
      color: white;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover { background-color: var(--btn-primary-hover); }
    .item-list, .dividend-list { margin-top: 15px; font-size: 14px; }
    #portfolioChartContainer {
      position: relative;
      width: 100%;
      max-width: 500px;
      margin: 20px auto;
    }
    #portfolioChart {
      width: 100% !important;
      height: auto !important;
    }
    .category-buttons {
      margin: 10px auto 15px auto;
      text-align: center;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 5px;
    }
    .category-buttons button {
      min-height: 35px;
      min-width: 60px;
      padding: 8px 12px;
      font-weight: bold;
      border: 2px solid #27ae60;
      background-color: var(--cat-btn-bg);
      color: #27ae60;
      font-family: 'IBM Plex Sans KR', sans-serif;
    }
    .category-buttons button.active {
      background-color: #27ae60;
      color: white;
    }
    .total {
      margin-top: 10px;
      font-weight: bold;
      text-align: center;
      font-size: 16px;
    }
    .totals-breakdown {
      text-align: center;
      font-size: 14px;
      margin-top: 5px;
    }
    .action-btn {
      background-color: var(--btn-danger);
      margin-left: 5px;
      padding: 4px 8px;
      font-size: 12px;
    }
    .edit-btn {
      background-color: var(--btn-edit);
      padding: 4px 8px;
      font-size: 12px;
    }
    .btn-dividend {
      background-color: var(--btn-dividend);
    }
    .btn-dividend:hover {
      background-color: var(--btn-dividend-hover);
    }
    input[type="file"] {
      display: none;
    }
    .file-label {
      display: inline-block;
      background-color: var(--file-label-bg);
      color: white;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      margin: 5px;
    }
    .theme-toggle {
      background-color: #555;
      font-size: 13px;
      padding: 6px 12px;
    }
    .theme-toggle:hover {
      background-color: #333;
    }

    /* ë°°ë‹¹ê¸ˆ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--overlay-bg);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: var(--modal-bg);
      padding: 20px;
      border-radius: 12px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 4px 15px var(--shadow);
    }
    .dividend-record {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      background: var(--dividend-record-bg);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
    }
    .dividend-summary {
      margin-top: 20px;
      background: var(--bg-secondary);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 1px 3px var(--shadow);
    }
  </style>
</head>
<body>
  <div style="display:flex; justify-content:space-between; align-items:center;">
    <h2>ğŸ“Š ì›¹ í¬íŠ¸í´ë¦¬ì˜¤ ì°¨íŠ¸</h2>
    <button class="theme-toggle" onclick="toggleTheme()" id="themeToggleBtn">ğŸŒ™ Dark</button>
  </div>
  <button id="loginBtn" hidden class="bg-red-500 text-white px-4 py-2 rounded">Google ë¡œê·¸ì¸</button>
  <button id="logoutBtn" hidden class="hidden text-sm underline text-gray-500">ë¡œê·¸ì•„ì›ƒ</button>
  
  <input hidden id="chartTitle" value="ë‚˜ì˜ í¬íŠ¸í´ë¦¬ì˜¤" onchange="updateChart()" />
  <div class="flex items-center space-x-2">
    <input
      id="chartNameInput"
      hidden
      type="text"
      placeholder="ì°¨íŠ¸ ì´ë¦„ ì…ë ¥"
      class="border border-gray-300 rounded px-3 py-2 text-sm"
      onchange="updateChart()"
    />
    <button
      id="firebaseSaveBtn"
      hidden
      class="text-sm underline text-gray-500 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
    >
      ì°¨íŠ¸ ì €ì¥
    </button>
  </div>
  <br/>
  <div style="display:flex; gap:5px; flex-wrap:wrap;">
    <button onclick="toggleForm()">+ ì¢…ëª© ì¶”ê°€</button>
    <button class="btn-dividend" onclick="openDividendModal()">+ ë°°ë‹¹ê¸ˆ ì¶”ê°€</button>
  </div>

  <div id="form" style="display:none; margin-top:10px; padding:10px; background:var(--bg-secondary); border-radius:8px;">
    <input id="name" placeholder="ì¢…ëª© ì´ë¦„" />
    <input id="amount" type="number" placeholder="ê°œìˆ˜" />
    <input id="price" type="number" placeholder="ê°€ê²©" />
    <select id="currency">
      <option value="KRW">ì›</option>
      <option value="USD">ë‹¬ëŸ¬</option>
    </select>
    <input id="category" placeholder="ì¹´í…Œê³ ë¦¬ (ì‰¼í‘œë¡œ êµ¬ë¶„)" />
    <button onclick="submitItem()">í™•ì¸</button>
  </div>

  <div style="margin-top:15px;">
    <label>ğŸ’± í™˜ìœ¨ (1 USD = ì›í™”):</label>
    <input id="exchangeRate" type="number" value="1300" onchange="updateAll()" />
  </div>

  <div class="item-list" id="itemList"></div>

  <div id="portfolioChartContainer">
    <canvas id="portfolioChart"></canvas>
  </div>

  <div class="category-buttons" id="categoryButtons"></div>

  <div class="total" id="totalAmount"></div>
  <div class="totals-breakdown" id="categoryTotals"></div>

  <div id="dividendListContainer"></div>
  <div id="dividendSummaryContainer"></div>

  <h3>ğŸ“‚ ë°ì´í„° ì €ì¥ ë° ë¶ˆëŸ¬ì˜¤ê¸°</h3>
  <button onclick="saveData()">ğŸ’¾ ì €ì¥ (ë¡œì»¬)</button>
  <button onclick="loadData()">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸° (ë¡œì»¬)</button>
  <button onclick="downloadCSV()">â¬‡ï¸ CSV ë‹¤ìš´ë¡œë“œ</button>
  <button onclick="downloadJSON()">â¬‡ï¸ JSON ë‹¤ìš´ë¡œë“œ</button>
  <label for="fileUpload" class="file-label">ğŸ“ JSON ì—…ë¡œë“œ</label>
  <input type="file" id="fileUpload" accept=".json" onchange="uploadFile(event)" />
  <label for="csvUpload" class="file-label">ğŸ“ CSV ì—…ë¡œë“œ</label>
  <input type="file" id="csvUpload" accept=".csv" onchange="uploadCSVFile(event)" />

  <h3>ğŸ“Š Google ê³„ì •ì— ì €ì¥ëœ ì°¨íŠ¸ ëª©ë¡</h3>
  <div id="chartList"></div>

  <div class="modal-overlay" id="dividendModal">
    <div class="modal-content">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <h3>ğŸ’° ë°°ë‹¹ê¸ˆ ê¸°ë¡</h3>
        <button onclick="closeDividendModal()" style="background:transparent; color:#999; border:none; font-size:20px;">âœ•</button>
      </div>
      <div style="display:flex; flex-direction:column; gap:8px;">
        <input id="divStockName" list="divStockList" placeholder="ì¢…ëª©ì´ë¦„ (ì§ì ‘ì…ë ¥ ë˜ëŠ” ì„ íƒ)" />
        <datalist id="divStockList"></datalist>
        <div style="display:flex; gap:5px;">
            <input id="divTotalAmount" type="number" step="0.01" placeholder="ë°°ë‹¹ê¸ˆì•¡" style="flex:1" />
            <select id="divCurrency" style="width: 80px;">
              <option value="KRW">KRW</option>
              <option value="USD">USD</option>
            </select>
        </div>
        <input id="divDate" type="date" />
        <input id="divNote" placeholder="ë©”ëª¨ (ì„ íƒ)" />
        <button class="btn-dividend" onclick="addDividendRecord()">ì¶”ê°€í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, getDocs, deleteDoc } from 'https://www.gstatic.com/firebasejs/11.6.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyC1-dNvQQbb4B5j6N5hZCI4dT8yTVu8y8o",
      authDomain: "my-portfolio-app-ae0e6.firebaseapp.com",
      databaseURL: "https://my-portfolio-app-ae0e6-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "my-portfolio-app-ae0e6",
      storageBucket: "my-portfolio-app-ae0e6.firebasestorage.app",
      messagingSenderId: "297732155840",
      appId: "1:297732155840:web:e7b288878e27f69fcc0025",
      measurementId: "G-HXMCWTC9PS"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    let currentUser = null;

    loginBtn.addEventListener('click', async () => {
      const provider = new GoogleAuthProvider();
      try {
        const result = await signInWithPopup(auth, provider);
        currentUser = result.user;
        console.log('âœ… ë¡œê·¸ì¸:', currentUser.email);
      } catch (err) {
        console.error('âŒ ë¡œê·¸ì¸ ì˜¤ë¥˜:', err.message);
      }
    });

    logoutBtn.addEventListener('click', () => {
      console.log("log out");
      signOut(auth);
    });

    onAuthStateChanged(auth, user => {
      const loginBtn = document.getElementById("loginBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const firebaseSaveBtn = document.getElementById("firebaseSaveBtn");
      const chartNameInput = document.getElementById("chartNameInput");
      if (user) {
        currentUser = user;
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        firebaseSaveBtn.style.display = 'inline-block';
        chartNameInput.style.display = 'inline-block';
        loadChartList();
      } else {
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        firebaseSaveBtn.style.display = 'none';
        chartNameInput.style.display = 'none';
        document.getElementById('chartList').innerHTML = '';
      }
    });

    const firebaseSaveBtn = document.getElementById('firebaseSaveBtn');
    const chartNameInput = document.getElementById('chartNameInput');

    firebaseSaveBtn.addEventListener('click', async () => {
      const chartName = chartNameInput.value.trim();
      if (!chartName) {
        alert('ì°¨íŠ¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!');
        return;
      }
      await saveToFirebase(chartName);
      chartNameInput.value = '';
    });

    async function saveToFirebase(chartName) {
      const data = {
        items,
        dividendRecords, // ë°°ë‹¹ê¸ˆ ë°ì´í„°ë„ ì €ì¥
        exchangeRate: getExchangeRate()
      };
      await setDoc(doc(db, 'dev_users', currentUser.uid, 'charts', chartName), {
        jsonData: JSON.stringify(data)
      });
      alert(`'${chartName}' ì´ë¦„ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      loadChartList();
    }

    async function loadChartList() {
      const chartListDiv = document.getElementById('chartList');
      chartListDiv.innerHTML = '';
      const chartsRef = collection(db, 'dev_users', currentUser.uid, 'charts');
      const snapshot = await getDocs(chartsRef);

      snapshot.forEach(docSnap => {
        const chartName = docSnap.id;
        const div = document.createElement('div');
        div.className = "flex items-center space-x-4";
        div.style.cssText = "margin-bottom:5px; display:flex; flex-wrap:wrap; align-items:center; gap:3px;";

        div.innerHTML = `
          <span style="display:inline-block; width:150px; font-weight:bold;">${chartName}</span>
          <button class="action-btn" style="background:var(--btn-save)" onclick="window.loadChartClick('${chartName}')">ë¶ˆëŸ¬ì˜¤ê¸°</button>
          <button class="action-btn" style="background:var(--btn-primary)" onclick="window.downloadChartJSON('${chartName}')">JSON</button>
          <button class="action-btn" style="background:var(--btn-primary)" onclick="window.downloadChartCSV('${chartName}')">CSV</button>
          <button class="action-btn" onclick="window.deleteChartClick(this, '${chartName}')">ì‚­ì œí•˜ê¸°</button>
        `;
        chartListDiv.appendChild(div);
      });

      if (snapshot.empty) {
        chartListDiv.innerHTML = '<p style="color:#888;">ì €ì¥ëœ ì°¨íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      }
    }

    // ëª¨ë“ˆ ìŠ¤ì½”í”„ í•¨ìˆ˜ë¥¼ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ (HTML onclickì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡)
    window.loadChartClick = async (chartName) => {
      const chartDocRef = doc(db, 'dev_users', currentUser.uid, 'charts', chartName);
      const chartDoc = await getDoc(chartDocRef);
      if (chartDoc.exists()) {
        const data = JSON.parse(chartDoc.data().jsonData);
        window.loadDataFromObject(data);
      } else {
        alert('ì°¨íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      }
    };

    window.downloadChartJSON = async (chartName) => {
      const chartDocRef = doc(db, 'dev_users', currentUser.uid, 'charts', chartName);
      const chartDoc = await getDoc(chartDocRef);
      if (!chartDoc.exists()) { alert('ì°¨íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const data = JSON.parse(chartDoc.data().jsonData);
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${chartName}.json`; a.click();
      URL.revokeObjectURL(url);
    };

    window.downloadChartCSV = async (chartName) => {
      const chartDocRef = doc(db, 'dev_users', currentUser.uid, 'charts', chartName);
      const chartDoc = await getDoc(chartDocRef);
      if (!chartDoc.exists()) { alert('ì°¨íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); return; }
      const data = JSON.parse(chartDoc.data().jsonData);
      const chartItems = data.items || [];
      const chartDividends = data.dividendRecords || [];

      let csvContent = "\uFEFF";
      csvContent += "[ë³´ìœ  ìì‚° ëª©ë¡]\n";
      csvContent += "ì´ë¦„,ê°œìˆ˜,ê°€ê²©,í†µí™”,ì¹´í…Œê³ ë¦¬,ë‚ ì§œ\n";
      csvContent += chartItems.map(i =>
        `${i.name},${i.amount},${i.price},${i.currency},"${i.categories.join('|')}",${i.date}`
      ).join('\n');
      csvContent += "\n\n";
      csvContent += "[ë°°ë‹¹ê¸ˆ ê¸°ë¡]\n";
      csvContent += "ì¢…ëª©ì´ë¦„,ë°°ë‹¹ê¸ˆì•¡,í†µí™”,ì§€ê¸‰ì¼,ë©”ëª¨\n";
      if (chartDividends.length > 0) {
        csvContent += chartDividends.map(d => {
          const safeNote = d.note ? d.note.replace(/"/g, '""') : '';
          return `${d.stockName},${d.totalAmount},${d.currency},${d.paymentDate},"${safeNote}"`;
        }).join('\n');
      }

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${chartName}.csv`; a.click();
      URL.revokeObjectURL(url);
    };

    window.deleteChartClick = async (selfElement, chartName) => {
        if(!confirm(`'${chartName}' ì°¨íŠ¸ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
        const chartDocRef = doc(db, 'dev_users', currentUser.uid, 'charts', chartName);
        try {
          await deleteDoc(chartDocRef);
          alert("ì‚­ì œ ì™„ë£Œ!");
          selfElement.parentElement.remove();
        } catch (error) {
          console.error("ì°¨íŠ¸ ì‚­ì œ ì˜¤ë¥˜:", error);
        }
    };
  </script>

  <script>
    let items = [];
    let dividendRecords = [];
    let portfolioChart = null;
    let selectedCategories = new Set();
    let editingIndex = null;

    // --- í…Œë§ˆ í† ê¸€ ---
    function toggleTheme() {
      const html = document.documentElement;
      const btn = document.getElementById('themeToggleBtn');
      if (html.getAttribute('data-theme') === 'dark') {
        html.removeAttribute('data-theme');
        btn.textContent = 'ğŸŒ™ Dark';
        localStorage.setItem('theme', 'light');
      } else {
        html.setAttribute('data-theme', 'dark');
        btn.textContent = 'â˜€ï¸ Light';
        localStorage.setItem('theme', 'dark');
      }
      updateChart();
    }

    // ì €ì¥ëœ í…Œë§ˆ ë³µì›
    (function() {
      const saved = localStorage.getItem('theme');
      if (saved === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.getElementById('themeToggleBtn').textContent = 'â˜€ï¸ Light';
      }
    })();

    // --- ê¸°ë³¸ ê¸°ëŠ¥ ---

    function toggleForm() {
      const form = document.getElementById('form');
      form.style.display = form.style.display === 'none' ? 'block' : 'none';
      if (form.style.display === 'none') clearForm();
    }

    function submitItem() {
      const name = document.getElementById('name').value;
      const amount = parseFloat(document.getElementById('amount').value);
      const price = parseFloat(document.getElementById('price').value);
      const currency = document.getElementById('currency').value;
      const categories = document.getElementById('category').value.split(',').map(c => c.trim()).filter(c => c);
      const date = new Date().toISOString().split('T')[0];

      if (!name || isNaN(amount) || isNaN(price)) {
        alert('ì´ë¦„, ê°œìˆ˜, ê°€ê²©ì„ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
      const item = { name, amount, price, currency, categories, date };
      if (editingIndex !== null) {
        items[editingIndex] = item;
        editingIndex = null;
      } else {
        items.push(item);
      }
      clearForm();
      updateAll();
    }

    function editItem(index) {
      const item = items[index];
      document.getElementById('name').value = item.name;
      document.getElementById('amount').value = item.amount;
      document.getElementById('price').value = item.price;
      document.getElementById('currency').value = item.currency;
      document.getElementById('category').value = item.categories.join(', ');
      editingIndex = index;
      document.getElementById('form').style.display = 'block';
    }

    function deleteItem(index) {
      if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        items.splice(index, 1);
        updateAll();
      }
    }

    function clearForm() {
      document.getElementById('name').value = '';
      document.getElementById('amount').value = '';
      document.getElementById('price').value = '';
      document.getElementById('currency').value = 'KRW';
      document.getElementById('category').value = '';
      editingIndex = null;
    }

    function getExchangeRate() {
      return parseFloat(document.getElementById('exchangeRate').value);
    }

    function getTotalValue(item) {
      const rate = getExchangeRate();
      return item.currency === 'USD' ? item.amount * item.price * rate : item.amount * item.price;
    }

    function updateAll() {
      updateList();
      updateCategoryButtons();
      updateChart();
      updateTotal();
      updateDividendList();
      updateDividendSummary();
    }

    function updateList() {
      const list = document.getElementById('itemList');
      list.innerHTML = items.map((i, idx) => `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; background: var(--bg-secondary); padding: 10px; border-radius: 8px; box-shadow: 0 1px 3px var(--shadow);">
          <div style="text-align: left;">
            <div>ğŸ“Œ ${i.name} - ${i.amount}ê°œ x ${i.price}${i.currency} = ${getTotalValue(i).toLocaleString()}ì›</div>
            <div style="margin-top: 4px; font-size: 13px; color: var(--text-secondary);">
              [${i.categories.join(', ')} | ${i.date}]
            </div>
          </div>
          <div>
            <button class="edit-btn" onclick="editItem(${idx})">âœï¸</button>
            <button class="action-btn" onclick="deleteItem(${idx})">ğŸ—‘ï¸</button>
          </div>
        </div>
      `).join('');
    }

    // --- ë°°ë‹¹ê¸ˆ ê´€ë ¨ ê¸°ëŠ¥ ---

    function openDividendModal() {
      const datalist = document.getElementById('divStockList');
      // ë³´ìœ  ì¢…ëª© ì´ë¦„ ìë™ì™„ì„±
      datalist.innerHTML = items.map(item => `<option value="${item.name}">`).join('');
      
      document.getElementById('divStockName').value = '';
      document.getElementById('divTotalAmount').value = '';
      document.getElementById('divDate').value = new Date().toISOString().split('T')[0];
      document.getElementById('divNote').value = '';
      document.getElementById('dividendModal').style.display = 'flex';
    }

    function closeDividendModal() {
      document.getElementById('dividendModal').style.display = 'none';
    }

    function addDividendRecord() {
      const stockName = document.getElementById('divStockName').value.trim();
      const totalAmount = parseFloat(document.getElementById('divTotalAmount').value);
      const currency = document.getElementById('divCurrency').value;
      const paymentDate = document.getElementById('divDate').value;
      const note = document.getElementById('divNote').value.trim();

      if (!stockName || isNaN(totalAmount) || !paymentDate) {
        alert('í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (ì¢…ëª©ëª…, ê¸ˆì•¡, ë‚ ì§œ)');
        return;
      }

      dividendRecords.push({
        id: Date.now().toString(36),
        stockName,
        totalAmount,
        currency,
        paymentDate,
        note
      });

      closeDividendModal();
      updateAll();
    }

    function deleteDividend(id) {
        if(confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            dividendRecords = dividendRecords.filter(d => d.id !== id);
            updateAll();
        }
    }

    function updateDividendList() {
        const container = document.getElementById('dividendListContainer');
        const rate = getExchangeRate();
        
        if (dividendRecords.length === 0) {
            container.innerHTML = '';
            return;
        }

        const sorted = [...dividendRecords].sort((a, b) => b.paymentDate.localeCompare(a.paymentDate));

        container.innerHTML = `
            <h3>ğŸ’° ë°°ë‹¹ê¸ˆ ë‚´ì—­ (${sorted.length}ê±´)</h3>
            <div class="dividend-list">
                ${sorted.map(d => {
                    const krw = d.currency === 'USD' ? d.totalAmount * rate : d.totalAmount;
                    return `
                        <div class="dividend-record">
                            <div>
                                <strong>${d.stockName}</strong> 
                                <span style="color:#8e44ad; font-weight:bold;">+${d.currency==='USD'?'$':''}${d.totalAmount.toLocaleString()}${d.currency==='KRW'?'ì›':''}</span>
                                <span style="color:#888; font-size:12px;">(${krw.toLocaleString()}ì›)</span>
                                <br/>
                                <span style="font-size:12px; color:#555;">${d.paymentDate} ${d.note ? ' Â· ' + d.note : ''}</span>
                            </div>
                            <button class="action-btn" onclick="deleteDividend('${d.id}')">ğŸ—‘ï¸</button>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }

    function updateDividendSummary() {
        const container = document.getElementById('dividendSummaryContainer');
        if (dividendRecords.length === 0) {
            container.innerHTML = '';
            return;
        }
        const rate = getExchangeRate();
        const total = dividendRecords.reduce((sum, d) => sum + (d.currency === 'USD' ? d.totalAmount * rate : d.totalAmount), 0);
        
        container.innerHTML = `
            <div class="dividend-summary" style="text-align:center;">
                <span style="font-size:14px; color:#555;">ì´ ë°°ë‹¹ê¸ˆ ìˆ˜ìµ</span><br/>
                <span style="font-size:20px; font-weight:bold; color:#8e44ad;">${total.toLocaleString()} ì›</span>
            </div>
        `;
    }


    // --- ì°¨íŠ¸ ë° ì¹´í…Œê³ ë¦¬ ê¸°ëŠ¥ ---

    function updateCategoryButtons() {
      const container = document.getElementById('categoryButtons');
      const allCategories = [...new Set(items.flatMap(i => i.categories))];
      if (allCategories.length === 0) {
        container.innerHTML = '';
        return;
      }
      const isAllSelected = selectedCategories.size === allCategories.length;
      const allButtonText = isAllSelected ? 'ì „ì²´ í•´ì œ' : 'ì „ì²´ ì„ íƒ';

      let html = `<button onclick="toggleAllCategories()" class="${isAllSelected || selectedCategories.size === 0 ? 'active' : ''}">${allButtonText}</button>`;
      html += allCategories.map(cat => `<button onclick="toggleCategory('${cat}')" class="${selectedCategories.has(cat) ? 'active' : ''}">${cat}</button>`).join('');
      container.innerHTML = html;
    }

    function toggleAllCategories() {
      const allCategories = [...new Set(items.flatMap(i => i.categories))];
      if (selectedCategories.size === allCategories.length) selectedCategories.clear();
      else selectedCategories = new Set(allCategories);
      updateCategoryButtons(); updateChart(); updateTotal();
    }

    function toggleCategory(cat) {
      if (selectedCategories.has(cat)) selectedCategories.delete(cat);
      else selectedCategories.add(cat);
      updateCategoryButtons(); updateChart(); updateTotal();
    }

    function isDarkMode() {
      return document.documentElement.getAttribute('data-theme') === 'dark';
    }

    function updateChart() {
      const ctx = document.getElementById('portfolioChart').getContext('2d');
      const categorySums = {};
      items.forEach(item => {
        const value = getTotalValue(item);
        item.categories.forEach(cat => {
          if (selectedCategories.size === 0 || selectedCategories.has(cat)) {
            categorySums[cat] = (categorySums[cat] || 0) + value;
          }
        });
      });

      const labels = Object.keys(categorySums);
      const values = Object.values(categorySums);
      if (portfolioChart) portfolioChart.destroy();

      const dark = isDarkMode();
      const legendColor = dark ? '#ccc' : '#666';
      const titleColor = dark ? '#e0e0e0' : '#333';
      const borderColor = dark ? '#1a1a2e' : '#fff';

      portfolioChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'],
            borderColor: borderColor,
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            datalabels: {
              formatter: (value, context) => {
                const sum = context.chart._metasets[0].total;
                return ((value / sum) * 100).toFixed(1) + '%';
              },
              color: '#fff', font: { weight: 'bold' }
            },
            legend: {
              position: 'bottom',
              labels: { color: legendColor }
            },
            title: {
              display: true,
              text: document.getElementById('chartTitle').value,
              color: titleColor
            }
          }
        },
        plugins: [ChartDataLabels]
      });
    }

    function updateTotal() {
      const totalDiv = document.getElementById('totalAmount');
      let sum = 0;
      items.forEach(item => {
        const value = getTotalValue(item);
        const matched = item.categories.some(cat => selectedCategories.size === 0 || selectedCategories.has(cat));
        if (matched) sum += value;
      });
      totalDiv.textContent = `ì´í•©: ${sum.toLocaleString()} ì›`;
    }

    // --- ì €ì¥ ë° ë¶ˆëŸ¬ì˜¤ê¸° (ë¡œì»¬/íŒŒì¼) ---

    // ë°ì´í„°ë¥¼ ì „ì—­ ê°ì²´ì— ë°˜ì˜í•˜ëŠ” í•¨ìˆ˜ (Firebase load ë“±ì—ì„œ ì‚¬ìš©)
    window.loadDataFromObject = (data) => {
        items = data.items || [];
        dividendRecords = data.dividendRecords || [];
        document.getElementById('exchangeRate').value = data.exchangeRate || 1300;
        updateAll();
        // alert('ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
    };

    function saveData() {
      const data = { items, dividendRecords, exchangeRate: getExchangeRate() };
      localStorage.setItem('portfolioData', JSON.stringify(data));
      alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function loadData() {
      const data = localStorage.getItem('portfolioData');
      if (data) window.loadDataFromObject(JSON.parse(data));
      else alert('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
    }

    function downloadJSON() {
      const blob = new Blob([JSON.stringify({ items, dividendRecords, exchangeRate: getExchangeRate() }, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'portfolio.json';
      a.click();
    }

    function uploadFile(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          window.loadDataFromObject(JSON.parse(e.target.result));
        } catch (e) { alert('JSON í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.'); }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // --- CSV ë‹¤ìš´ë¡œë“œ ë° ì—…ë¡œë“œ í•µì‹¬ ë¡œì§ ---

    function downloadCSV() {
      // 1. BOM ì¶”ê°€ (ì—‘ì…€ í•œê¸€ ê¹¨ì§ ë°©ì§€)
      let csvContent = "\uFEFF";

      // 2. ìì‚° ì„¹ì…˜ ì‘ì„±
      csvContent += "[ë³´ìœ  ìì‚° ëª©ë¡]\n";
      csvContent += "ì´ë¦„,ê°œìˆ˜,ê°€ê²©,í†µí™”,ì¹´í…Œê³ ë¦¬,ë‚ ì§œ\n";
      csvContent += items.map(i => 
        `${i.name},${i.amount},${i.price},${i.currency},"${i.categories.join('|')}",${i.date}`
      ).join('\n');
      
      csvContent += "\n\n"; // ì„¹ì…˜ êµ¬ë¶„

      // 3. ë°°ë‹¹ê¸ˆ ì„¹ì…˜ ì‘ì„±
      csvContent += "[ë°°ë‹¹ê¸ˆ ê¸°ë¡]\n";
      csvContent += "ì¢…ëª©ì´ë¦„,ë°°ë‹¹ê¸ˆì•¡,í†µí™”,ì§€ê¸‰ì¼,ë©”ëª¨\n";
      
      if (dividendRecords.length > 0) {
        csvContent += dividendRecords.map(d => {
            const safeNote = d.note ? d.note.replace(/"/g, '""') : '';
            return `${d.stockName},${d.totalAmount},${d.currency},${d.paymentDate},"${safeNote}"`;
        }).join('\n');
      }

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'portfolio.csv';
      a.click();
    }

    function uploadCSVFile(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const text = e.target.result;
          const lines = text.split('\n');
          
          let currentSection = 'items'; // ê¸°ë³¸ê°’ì€ ìì‚° ëª©ë¡ (í—¤ë” ì—†ëŠ” êµ¬ë²„ì „ íŒŒì¼ í˜¸í™˜)
          const newItems = [];
          const newDividends = [];

          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            // ì„¹ì…˜ ê°ì§€
            if (line.includes('[ë³´ìœ  ìì‚° ëª©ë¡]')) { currentSection = 'items'; continue; }
            if (line.includes('[ë°°ë‹¹ê¸ˆ ê¸°ë¡]')) { currentSection = 'dividends'; continue; }
            
            // í—¤ë” ê±´ë„ˆë›°ê¸°
            if (line.startsWith('ì´ë¦„,ê°œìˆ˜') || line.startsWith('Name,Amount') || line.startsWith('ì¢…ëª©ì´ë¦„,ë°°ë‹¹ê¸ˆì•¡')) continue;

            if (currentSection === 'items') {
                // ìì‚° ë°ì´í„° íŒŒì‹±
                const match = line.match(/^(.*?),([\d.]+),([\d.]+),(KRW|USD),"([^"]*)",(\d{4}-\d{2}-\d{2})$/);
                if (match) {
                    const [, name, amount, price, currency, categories, date] = match;
                    newItems.push({
                        name: name.trim(),
                        amount: parseFloat(amount),
                        price: parseFloat(price),
                        currency: currency.trim(),
                        categories: categories.split('|').map(c => c.trim()),
                        date: date.trim()
                    });
                }
            } else if (currentSection === 'dividends') {
                // ë°°ë‹¹ê¸ˆ ë°ì´í„° íŒŒì‹±: ì¢…ëª©ì´ë¦„,ê¸ˆì•¡,í†µí™”,ë‚ ì§œ,"ë©”ëª¨"
                // ê°„ë‹¨í•œ íŒŒì‹± (ë©”ëª¨ì— ì½¤ë§ˆê°€ ìˆì„ ê²½ìš° ì •ê·œì‹ í•„ìš”í•˜ì§€ë§Œ ì—¬ê¸°ì„  ê°„ë‹¨íˆ split ì²˜ë¦¬ ë³´ì™„)
                // ì •ê·œì‹: ì´ë¦„, ê¸ˆì•¡, í†µí™”, ë‚ ì§œ, "ë©”ëª¨"
                const matchDiv = line.match(/^(.*?),([\d.]+),(KRW|USD),(\d{4}-\d{2}-\d{2}),"(.*)"$/);
                if (matchDiv) {
                    const [, stockName, totalAmount, currency, paymentDate, note] = matchDiv;
                    newDividends.push({
                        id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
                        stockName: stockName.trim(),
                        totalAmount: parseFloat(totalAmount),
                        currency: currency.trim(),
                        paymentDate: paymentDate.trim(),
                        note: note.trim()
                    });
                }
            }
          }

          if (newItems.length > 0 || newDividends.length > 0) {
              items = newItems;
              dividendRecords = newDividends;
              updateAll();
              alert(`ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ! (ìì‚°: ${newItems.length}ê°œ, ë°°ë‹¹: ${newDividends.length}ê°œ)`);
          } else {
              alert('ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }

        } catch (err) {
          alert('CSV í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤: ' + err.message);
          console.error(err);
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
    document.getElementById('dividendModal').addEventListener('click', function(e) {
        if (e.target === this) closeDividendModal();
    });

    updateAll();
  </script>
</body>
</html>